<!DOCTYPE html>
<html lang="en-GB">
<head>
	<link href='http://fonts.googleapis.com/css?family=Averia+Libre' rel='stylesheet' type='text/css'>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="/static/css/bootstrap.min.css" />
	<link rel="stylesheet" href="/static/css/bootstrap-responsive.min.css" />
	<link rel="stylesheet" href="/static/css/base.css" />
	<!--[if lt IE 9]>
	<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<script src="/static/js/bootstrap.min.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js"></script>
	<meta name="viewport" content="initial-scale=1.0">
	<title>Building Sparkle updates with Fabric</title>
</head>
<body>
	<div class="container">	
		<div class="row">
			<div id="header" class="span12">
				<h1>JScott.me</h1>
			</div>
		</div>
		<article id="post">
	<h1><a href="/">&larr; Building Sparkle updates with Fabric</a></h1>
	&#13;
<p>This is my <a href="http://docs.fabfile.org/">fabfile</a> which builds and releases a version of my Objective-C project. It updates the version (resetting it to 99.99.99 afterwards), swaps development and live versions of files, builds the system, creates and uploads deltas used for <a href="http://sparkle.andymatuschak.org/">Sparkle</a> and finally uploads the latest version itself. I'm sure it's not perfect but it might help others trying to do the same thing.</p>&#13;
&#13;
<pre>from fabric.api import local, run, env, settings&#13;
from fabric.operations import put, prompt&#13;
&#13;
import os&#13;
&#13;
# Requires py2app&#13;
import plistlib&#13;
from plistlib import Plist&#13;
&#13;
import zipfile&#13;
&#13;
import os,stat, sys&#13;
from cStringIO import StringIO&#13;
&#13;
import urllib2_file&#13;
import urllib2&#13;
&#13;
import shutil&#13;
&#13;
# set env variables hereâ€¦&#13;
&#13;
def ZipDir(inputDir, outputZip):&#13;
    '''Zip up a directory and preserve symlinks and empty directories'''&#13;
    zipOut = zipfile.ZipFile(outputZip, 'w', compression=zipfile.ZIP_DEFLATED)&#13;
    &#13;
    rootLen = len(os.path.dirname(inputDir))&#13;
    def _ArchiveDirectory(parentDirectory):&#13;
        contents = os.listdir(parentDirectory)&#13;
        #store empty directories&#13;
        if not contents:&#13;
            #http://www.velocityreviews.com/forums/t318840-add-empty-directory-using-zipfile.html&#13;
            archiveRoot = parentDirectory[rootLen:].replace('\\', '/').lstrip('/')&#13;
            zipInfo = zipfile.ZipInfo(archiveRoot+'/')&#13;
            zipOut.writestr(zipInfo, '')&#13;
        for item in contents:&#13;
            fullPath = os.path.join(parentDirectory, item)&#13;
            if os.path.isdir(fullPath) and not os.path.islink(fullPath):&#13;
                _ArchiveDirectory(fullPath)&#13;
            else:&#13;
                archiveRoot = fullPath[rootLen:].replace('\\', '/').lstrip('/')&#13;
                if os.path.islink(fullPath):&#13;
                    # http://www.mail-archive.com/python-list@python.org/msg34223.html&#13;
                    zipInfo = zipfile.ZipInfo(archiveRoot)&#13;
                    zipInfo.create_system = 3&#13;
                    # long type of hex val of '0xA1ED0000L',&#13;
                    # say, symlink attr magic...&#13;
                    zipInfo.external_attr = 2716663808L&#13;
                    zipOut.writestr(zipInfo, os.readlink(fullPath))&#13;
                else:&#13;
                    zipOut.write(fullPath, archiveRoot, zipfile.ZIP_DEFLATED)&#13;
    _ArchiveDirectory(inputDir)&#13;
    &#13;
    zipOut.close()&#13;
&#13;
&#13;
def build(version):&#13;
    """ Build with a specified version """&#13;
    with settings(warn_only=True):&#13;
        plist = Plist.fromFile('SeaweedPlayer-Info.plist')&#13;
        plist['CFBundleVersion'] = version&#13;
        plist['CFBundleShortVersionString'] = version&#13;
        plistlib.writePlist(plist, 'SeaweedPlayer-Info.plist')&#13;
&#13;
        os.rename('SeaweedPlayer/Configuration.m', 'SeaweedPlayer/ConfigurationDev.m')&#13;
        os.rename('SeaweedPlayer/ConfigurationLive.m', 'SeaweedPlayer/Configuration.m')&#13;
&#13;
        result = local('xcodebuild -project SeaweedPlayer.xcodeproj -target Release')&#13;
&#13;
        plist['CFBundleVersion'] = '99.99.99'&#13;
        plist['CFBundleShortVersionString'] = '99.99.99'&#13;
        plistlib.writePlist(plist, 'SeaweedPlayer-Info.plist')&#13;
&#13;
        os.rename('SeaweedPlayer/Configuration.m', 'SeaweedPlayer/ConfigurationLive.m')&#13;
        os.rename('SeaweedPlayer/ConfigurationDev.m', 'SeaweedPlayer/Configuration.m')&#13;
    if result.failed:&#13;
        return False&#13;
    return True&#13;
&#13;
def release(version, deltas=''):&#13;
    if build(version):&#13;
        ZipDir("build/Release/SeaweedPlayer.app", "seaweed_" + version + ".zip")&#13;
&#13;
        # At this point we have a seaweed_1.0.zip file containing the .app&#13;
        shutil.copytree("build/Release/SeaweedPlayer.app", "old_builds/" + version + ".app", symlinks=True)&#13;
&#13;
        # Create deltas from specified versions&#13;
        deltas = deltas.split(':')&#13;
        for delta in deltas:&#13;
            local("./BinaryDelta create old_builds/" + delta + ".app/ old_builds/" + version + ".app/ delta_" + delta + "_" + version)&#13;
&#13;
            # Upload the file&#13;
            put("delta_" + delta + "_" + version, "/home/public/updates/delta_" + delta + "_" + version)&#13;
&#13;
            # Sign it&#13;
            signature = local("openssl dgst -sha1 -binary &lt; \"delta_" + delta + "_" + version + "\" | openssl dgst -dss1 -sign \"dsa_priv.pem\" | openssl enc -base64", capture=True)&#13;
&#13;
            # Insert into the database&#13;
            run('echo "use seaweed; INSERT INTO update_deltas SET to_version = \'%s\', from_version = \'%s\', signature = \'%s\';"|mysql --batch --user=%s --password=%s --host=%s' % (version, delta, signature, env.mysqluser, env.mysqlpassword, env.mysqlhost), pty=True)&#13;
&#13;
            local("rm delta_" + delta + "_" + version)&#13;
        &#13;
        # Sign it&#13;
        signature = local("openssl dgst -sha1 -binary &lt; \"seaweed_" + version + ".zip\" | openssl dgst -dss1 -sign \"dsa_priv.pem\" | openssl enc -base64", capture=True)&#13;
        &#13;
        if os.path.isfile("description.txt"):&#13;
            description = open('description.txt').read()&#13;
            local("rm description.txt")&#13;
        else:&#13;
            description = prompt('What is the description of the update?')&#13;
&#13;
        # Upload the file&#13;
        put('seaweed_' + version + '.zip', '/home/public/updates/seaweed_' + version + '.zip')&#13;
&#13;
        # Insert into the database&#13;
        run('echo "use seaweed; INSERT INTO updates SET version = \'%s\', description = \'%s\', signature = \'%s\';"|mysql --batch --user=%s --password=%s --host=%s' % (version, description, signature, env.mysqluser, env.mysqlpassword, env.mysqlhost), pty=True)&#13;
&#13;
        # Update front page&#13;
        run("echo '<!--?php $version = \"" + version + "\";'  --> _version.php")&#13;
        &#13;
        local("rm seaweed_" + version + ".zip;")&#13;
    else:&#13;
        print "Build Error"&#13;
</pre> 

</article>
		<div class="row">
			<div id="footer" class="span12">
				<ul>
					<li><a target="_blank" rel="me" href="http://twitter.com/jscott1989">Twitter</a></li>
					<li><a target="_blank" rel="me" href="http://facebook.com/jscott1989">Facebook</a></li>
					<li><a target="_blank" rel="me" href="http://bitbucket.org/jscott1989">Bitbucket</a></li>
					<li><a target="_blank" rel="me" href="https://github.com/jscott1989">GitHub</a></li>
					<li><a target="_blank" rel="me" href="http://www.linkedin.com/in/jscott1989">LinkedIn</a></li>
					<li><a target="_blank" rel="me" href="http://stackoverflow.com/users/203715/jscott1989">StackOverflow</a></li>
				</ul>
				<span>Designed by <a href="http://jscott.me">Jonathan Scott</a>. Some icons by <a href="http://p.yusukekamiyamane.com/">Yusuke Kamiyamane</a></span>.
			</div>
		</div>
	</div>
</body>
</html>